services:
  residencyroll-api:
    image: ghcr.io/glenconway/residencyroll/api:latest
    container_name: ResidencyRoll-Api
    ports:
      - "${API_PORT}:${API_INTERNAL_PORT}"
    volumes:
      - residencyroll-api-data:/app/data
    environment:
      - ASPNETCORE_ENVIRONMENT=${ASPNETCORE_ENVIRONMENT}
      - ASPNETCORE_URLS=http://+:${API_INTERNAL_PORT}
      - ConnectionStrings__Default=Data Source=${DB_PATH}
      - Jwt__Authority=${JWT_AUTHORITY}
      - Jwt__Audience=${JWT_AUDIENCE}
      - Jwt__RequireHttpsMetadata=${JWT_REQUIRE_HTTPS}
      - Jwt__ClientSecret=${OIDC_CLIENT_SECRET}
      - Cors__AllowedOrigins__0=${CORS_ORIGIN_0}
      - Cors__AllowedOrigins__1=${CORS_ORIGIN_1}
      - ForwardedHeaders__KnownProxies__0=${FORWARDED_HEADERS_KNOWN_PROXY_0}
      - ForwardedHeaders__KnownProxies__1=${FORWARDED_HEADERS_KNOWN_PROXY_1}
      - ForwardedHeaders__KnownNetworks__0=${FORWARDED_HEADERS_KNOWN_NETWORK_0}
      - ForwardedHeaders__KnownNetworks__1=${FORWARDED_HEADERS_KNOWN_NETWORK_1}
    restart: unless-stopped
    networks:
      - residencyroll-network

  residencyroll-web:
    image: ghcr.io/glenconway/residencyroll/web:latest
    container_name: ResidencyRoll-Web
    ports:
      - "${WEB_PORT}:${WEB_INTERNAL_PORT}"
    volumes:
      - residencyroll-web-data:/app/data
    environment:
      - ASPNETCORE_ENVIRONMENT=${ASPNETCORE_ENVIRONMENT}
      - ASPNETCORE_URLS=http://+:${WEB_INTERNAL_PORT}
      - Api__BaseUrl=http://residencyroll-api:${API_INTERNAL_PORT}
      - Authentication__OpenIdConnect__Enabled=${OIDC_ENABLED}
      - Authentication__OpenIdConnect__Authority=${OIDC_AUTHORITY}
      - Authentication__OpenIdConnect__ClientId=${OIDC_CLIENT_ID}
      - Authentication__OpenIdConnect__ClientSecret=${OIDC_CLIENT_SECRET}
      - Authentication__OpenIdConnect__RequireHttpsMetadata=${OIDC_REQUIRE_HTTPS}
      - Authentication__OpenIdConnect__ApiScope=${OIDC_API_SCOPE}
      - ForwardedHeaders__KnownProxies__0=${FORWARDED_HEADERS_KNOWN_PROXY_0}
      - ForwardedHeaders__KnownProxies__1=${FORWARDED_HEADERS_KNOWN_PROXY_1}
      - ForwardedHeaders__KnownNetworks__0=${FORWARDED_HEADERS_KNOWN_NETWORK_0}
      - ForwardedHeaders__KnownNetworks__1=${FORWARDED_HEADERS_KNOWN_NETWORK_1}
    restart: unless-stopped
    depends_on:
      - residencyroll-api
    networks:
      - residencyroll-network

volumes:
  residencyroll-api-data:
  residencyroll-web-data:

networks:
  residencyroll-network:
    driver: bridge

