@page "/"
@using Radzen
@using Radzen.Blazor
@using ResidencyRoll.Web.Models
@using ResidencyRoll.Web.Services
@inject TripService TripService
@rendermode InteractiveServer

<PageTitle>ResidencyRoll - Travel Tracker</PageTitle>

<h1>ResidencyRoll - Travel Tracking Dashboard</h1>

<RadzenRow Gap="1rem" class="rz-mt-4">
    <RadzenColumn Size="12" SizeMD="6">
        <RadzenCard>
            <h3>Days Distribution (Last 365 Days)</h3>
            <RadzenChart Style="width: 100%; height: 300px;">
                <RadzenBarSeries Data="@distributionData" CategoryProperty="Label" ValueProperty="Value">
                    <RadzenSeriesDataLabels Visible="true" />
                </RadzenBarSeries>
                <RadzenLegend Visible="false" />
            </RadzenChart>
        </RadzenCard>
    </RadzenColumn>
    <RadzenColumn Size="12" SizeMD="6">
        <RadzenCard>
            <h3>Days per Country (Last 365 Days)</h3>
            <RadzenChart Style="width: 100%; height: 300px;">
                <RadzenDonutSeries Data="@chartData" CategoryProperty="Label" ValueProperty="Days" />
            </RadzenChart>
        </RadzenCard>
    </RadzenColumn>
</RadzenRow>

<RadzenRow Gap="1rem" class="rz-mt-4">
    <RadzenColumn Size="12">
        <RadzenCard>
            <h3>Trip Timeline</h3>
            @if (timelineItems.Count == 0)
            {
                <RadzenAlert Severity="AlertSeverity.Info" Style="margin: 0">Add a trip to see your timeline.</RadzenAlert>
            }
            else
            {
                <div style="max-height: 320px; overflow-y: auto; padding-right: 0.5rem;">
                    <RadzenTimeline LineColor="#0d6efd" IndicatorColor="#0d6efd">
                        @foreach (var item in timelineItems)
                        {
                            <RadzenTimelineItem>
                                <ChildContent>
                                    <div style="display: flex; flex-direction: column; gap: 0.15rem;">
                                        <div style="font-weight: 700; font-size: 1rem;">@item.Title</div>
                                        <div style="color: #6c757d;">@item.Subtitle</div>
                                        <div style="font-size: 0.9rem; color: #0d6efd; font-weight: 600;">@item.DurationText</div>
                                    </div>
                                </ChildContent>
                            </RadzenTimelineItem>
                        }
                    </RadzenTimeline>
                </div>
            }
        </RadzenCard>
    </RadzenColumn>
</RadzenRow>

@code {
    private List<Trip> timelineTrips = new();
    private List<TimelineItem> timelineItems = new();
    private int daysAway;
    private int daysHome;
    private List<ChartData> chartData = new();
    private List<DistributionData> distributionData = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        timelineTrips = await TripService.GetTripsForTimelineAsync();
        daysAway = await TripService.GetTotalDaysAwayInLast365DaysAsync();
        daysHome = await TripService.GetDaysAtHomeInLast365DaysAsync();
        
        var daysPerCountry = await TripService.GetDaysPerCountryInLast365DaysAsync();
        chartData = daysPerCountry
            .Select(kvp => new ChartData { Label = $"{kvp.Key} ({kvp.Value} days)", Days = kvp.Value })
            .ToList();
        
        distributionData = new List<DistributionData>
        {
            new DistributionData { Label = "Days Away", Value = daysAway },
            new DistributionData { Label = "Days Home", Value = daysHome }
        };

        timelineItems = timelineTrips
            .OrderByDescending(t => t.StartDate)
            .Select(t => new TimelineItem
            {
                Title = t.CountryName,
                Subtitle = $"{t.StartDate:MMM dd, yyyy} â€“ {t.EndDate:MMM dd, yyyy}",
                DurationText = $"{(t.EndDate - t.StartDate).Days + 1} days"
            })
            .ToList();
        
        StateHasChanged();
    }

    public class ChartData
    {
        public string Label { get; set; } = string.Empty;
        public int Days { get; set; }
    }

    public class DistributionData
    {
        public string Label { get; set; } = string.Empty;
        public int Value { get; set; }
    }

    public class TimelineItem
    {
        public string Title { get; set; } = string.Empty;
        public string Subtitle { get; set; } = string.Empty;
        public string DurationText { get; set; } = string.Empty;
    }
}
