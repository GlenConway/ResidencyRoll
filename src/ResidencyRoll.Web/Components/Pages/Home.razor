@page "/"
@using Radzen
@using Radzen.Blazor
@using ResidencyRoll.Web.Models
@using ResidencyRoll.Web.Services
@using ResidencyRoll.Web.Components
@inject TripService TripService
@rendermode InteractiveServer

<PageTitle>ResidencyRoll - Travel Tracker</PageTitle>

<h1>ResidencyRoll - Travel Tracking Dashboard</h1>

<RadzenRow Gap="1rem" class="rz-mt-4">
    <RadzenColumn Size="12" SizeMD="6">
        <DaysDistributionChart DistributionData="@distributionData" />
    </RadzenColumn>
    <RadzenColumn Size="12" SizeMD="6">
        <DaysPerCountryChart ChartData="@chartData" />
    </RadzenColumn>
</RadzenRow>

<RadzenRow Gap="1rem" class="rz-mt-4">
    <RadzenColumn Size="12">
        <TripTimeline TimelineItems="@timelineItems" />
    </RadzenColumn>
</RadzenRow>

@code {
    private List<Trip> timelineTrips = new();
    private List<TripTimeline.TimelineItem> timelineItems = new();
    private int daysAway;
    private int daysHome;
    private List<ChartData> chartData = new();
    private List<DistributionData> distributionData = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        timelineTrips = await TripService.GetTripsForTimelineAsync();
        daysAway = await TripService.GetTotalDaysAwayInLast365DaysAsync();
        daysHome = await TripService.GetDaysAtHomeInLast365DaysAsync();
        
        var daysPerCountry = await TripService.GetDaysPerCountryInLast365DaysAsync();
        chartData = daysPerCountry
            .Select(kvp => new ChartData { Label = $"{kvp.Key} ({kvp.Value} days)", Days = kvp.Value })
            .ToList();
        
        distributionData = new List<DistributionData>
        {
            new DistributionData { Label = "Days Away", Value = daysAway },
            new DistributionData { Label = "Days Home", Value = daysHome }
        };

        timelineItems = timelineTrips
            .OrderByDescending(t => t.StartDate)
            .Select(t => new TripTimeline.TimelineItem
            {
                Title = t.CountryName,
                Subtitle = $"{t.StartDate:MMM dd, yyyy} â€“ {t.EndDate:MMM dd, yyyy}",
                DurationText = $"{(t.EndDate - t.StartDate).Days + 1} days"
            })
            .ToList();
        
        StateHasChanged();
    }
}
