@page "/"
@using Radzen
@using Radzen.Blazor
@using ResidencyRoll.Web.Models
@using ResidencyRoll.Web.Services
@inject TripService TripService
@rendermode InteractiveServer

<PageTitle>ResidencyRoll - Travel Tracker</PageTitle>

<h1>ResidencyRoll - Travel Tracking Dashboard</h1>

<RadzenRow Gap="1rem" class="rz-mt-4">
    <RadzenColumn Size="12" SizeMD="6">
        <RadzenCard>
            <h3>Days Distribution (Last 365 Days)</h3>
            <RadzenChart Style="width: 100%; height: 300px;">
                <RadzenBarSeries Data="@distributionData" CategoryProperty="Label" ValueProperty="Value">
                    <RadzenSeriesDataLabels Visible="true" />
                </RadzenBarSeries>
                <RadzenChartOptions>
                    <RadzenLegend Visible="false" />
                </RadzenChartOptions>
            </RadzenChart>
        </RadzenCard>
    </RadzenColumn>
    <RadzenColumn Size="12" SizeMD="6">
        <RadzenCard>
            <h3>Days per Country (Last 365 Days)</h3>
            <RadzenChart Style="width: 100%; height: 300px;">
                <RadzenDonutSeries Data="@chartData" CategoryProperty="Country" ValueProperty="Days" />
            </RadzenChart>
        </RadzenCard>
    </RadzenColumn>
</RadzenRow>

<RadzenRow Gap="1rem" class="rz-mt-4">
    <RadzenColumn Size="12">
        <RadzenCard>
            <h3>Manage Trips</h3>
            <RadzenDataGrid @ref="tripsGrid" Data="@trips" TItem="Trip" 
                            AllowFiltering="true" AllowSorting="true" 
                            EditMode="DataGridEditMode.Single"
                            RowUpdate="@OnUpdateRow" RowCreate="@OnCreateRow">
                <Columns>
                    <RadzenDataGridColumn TItem="Trip" Property="CountryName" Title="Country" Width="200px">
                        <EditTemplate Context="trip">
                            <RadzenTextBox @bind-Value="trip.CountryName" Style="width:100%; display: block" />
                        </EditTemplate>
                    </RadzenDataGridColumn>
                    <RadzenDataGridColumn TItem="Trip" Property="StartDate" Title="Start Date" Width="150px">
                        <Template Context="trip">
                            @trip.StartDate.ToString("yyyy-MM-dd")
                        </Template>
                        <EditTemplate Context="trip">
                            <RadzenDatePicker @bind-Value="trip.StartDate" Style="width:100%; display: block" />
                        </EditTemplate>
                    </RadzenDataGridColumn>
                    <RadzenDataGridColumn TItem="Trip" Property="EndDate" Title="End Date" Width="150px">
                        <Template Context="trip">
                            @trip.EndDate.ToString("yyyy-MM-dd")
                        </Template>
                        <EditTemplate Context="trip">
                            <RadzenDatePicker @bind-Value="trip.EndDate" Style="width:100%; display: block" />
                        </EditTemplate>
                    </RadzenDataGridColumn>
                    <RadzenDataGridColumn TItem="Trip" Context="trip" Filterable="false" Sortable="false" TextAlign="TextAlign.Center" Width="150px">
                        <Template Context="trip">
                            <RadzenButton Icon="edit" ButtonStyle="ButtonStyle.Light" Click="@(args => EditRow(trip))" />
                            <RadzenButton Icon="delete" ButtonStyle="ButtonStyle.Danger" Click="@(args => DeleteRow(trip))" />
                        </Template>
                        <EditTemplate Context="trip">
                            <RadzenButton Icon="check" ButtonStyle="ButtonStyle.Success" Click="@(args => SaveRow(trip))" />
                            <RadzenButton Icon="close" ButtonStyle="ButtonStyle.Light" Click="@(args => CancelEdit(trip))" />
                        </EditTemplate>
                    </RadzenDataGridColumn>
                </Columns>
            </RadzenDataGrid>
            <RadzenButton Icon="add_circle_outline" Text="Add Trip" Click="@InsertRow" ButtonStyle="ButtonStyle.Primary" class="rz-mt-2" />
        </RadzenCard>
    </RadzenColumn>
</RadzenRow>

<RadzenRow Gap="1rem" class="rz-mt-4">
    <RadzenColumn Size="12">
        <RadzenCard>
            <h3>Trip Timeline</h3>
            @if (timelineItems.Count == 0)
            {
                <RadzenAlert Severity="AlertSeverity.Info" Style="margin: 0">Add a trip to see your timeline.</RadzenAlert>
            }
            else
            {
                <div style="max-height: 320px; overflow-y: auto; padding-right: 0.5rem;">
                    <RadzenTimeline LineColor="#0d6efd" IndicatorColor="#0d6efd">
                        @foreach (var item in timelineItems)
                        {
                            <RadzenTimelineItem>
                                <ChildContent>
                                    <div style="display: flex; flex-direction: column; gap: 0.15rem;">
                                        <div style="font-weight: 700; font-size: 1rem;">@item.Title</div>
                                        <div style="color: #6c757d;">@item.Subtitle</div>
                                        <div style="font-size: 0.9rem; color: #0d6efd; font-weight: 600;">@item.DurationText</div>
                                    </div>
                                </ChildContent>
                            </RadzenTimelineItem>
                        }
                    </RadzenTimeline>
                </div>
            }
        </RadzenCard>
    </RadzenColumn>
</RadzenRow>

@code {
    private List<Trip> trips = new();
    private List<Trip> timelineTrips = new();
    private List<TimelineItem> timelineItems = new();
    private RadzenDataGrid<Trip>? tripsGrid;
    private int daysAway;
    private int daysHome;
    private List<ChartData> chartData = new();
    private List<DistributionData> distributionData = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        trips = await TripService.GetAllTripsAsync();
        timelineTrips = await TripService.GetTripsForTimelineAsync();
        daysAway = await TripService.GetTotalDaysAwayInLast365DaysAsync();
        daysHome = await TripService.GetDaysAtHomeInLast365DaysAsync();
        
        var daysPerCountry = await TripService.GetDaysPerCountryInLast365DaysAsync();
        chartData = daysPerCountry.Select(kvp => new ChartData { Country = kvp.Key, Days = kvp.Value }).ToList();
        
        distributionData = new List<DistributionData>
        {
            new DistributionData { Label = "Days Away", Value = daysAway },
            new DistributionData { Label = "Days Home", Value = daysHome }
        };

        timelineItems = timelineTrips
            .OrderByDescending(t => t.StartDate)
            .Select(t => new TimelineItem
            {
                Title = t.CountryName,
                Subtitle = $"{t.StartDate:MMM dd, yyyy} â€“ {t.EndDate:MMM dd, yyyy}",
                DurationText = $"{(t.EndDate - t.StartDate).Days + 1} days"
            })
            .ToList();
        
        StateHasChanged();
    }

    private async Task OnUpdateRow(Trip trip)
    {
        await TripService.UpdateTripAsync(trip);
        await LoadData();
    }

    private async Task OnCreateRow(Trip trip)
    {
        await TripService.CreateTripAsync(trip);
        await LoadData();
    }

    private async Task EditRow(Trip trip)
    {
        await tripsGrid!.EditRow(trip);
    }

    private async Task SaveRow(Trip trip)
    {
        await tripsGrid!.UpdateRow(trip);
    }

    private void CancelEdit(Trip trip)
    {
        tripsGrid!.CancelEditRow(trip);
    }

    private async Task DeleteRow(Trip trip)
    {
        await TripService.DeleteTripAsync(trip.Id);
        await LoadData();
    }

    private async Task InsertRow()
    {
        var newTrip = new Trip { StartDate = DateTime.Today, EndDate = DateTime.Today };
        await tripsGrid!.InsertRow(newTrip);
    }

    public class ChartData
    {
        public string Country { get; set; } = string.Empty;
        public int Days { get; set; }
    }

    public class DistributionData
    {
        public string Label { get; set; } = string.Empty;
        public int Value { get; set; }
    }

    public class TimelineItem
    {
        public string Title { get; set; } = string.Empty;
        public string Subtitle { get; set; } = string.Empty;
        public string DurationText { get; set; } = string.Empty;
    }
}
