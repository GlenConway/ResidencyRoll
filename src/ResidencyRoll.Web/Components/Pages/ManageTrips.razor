@page "/manage-trips"
@attribute [Microsoft.AspNetCore.Authorization.Authorize]
@using Radzen
@using Radzen.Blazor
@using System.Globalization
@using System.Net.Http.Headers
@using Microsoft.AspNetCore.Components.Forms
@using ResidencyRoll.Shared.Trips
@using ResidencyRoll.Web.Services
@using ResidencyRoll.Web.Components
@inject TripsApiClient ApiClient
@inject HttpClient Http
@inject NavigationManager Navigation
@rendermode InteractiveServer

<PageTitle>Manage Trips</PageTitle>

<h1>Manage Trips</h1>

<RadzenTabs>
    <Tabs>
        <RadzenTabsItem Text="Trip List">
            <RadzenRow Gap="1rem" class="rz-mt-3">
                <RadzenColumn Size="12" SizeMD="6">
                    <RadzenButton Icon="download" Text="Export Trips (CSV)" ButtonStyle="ButtonStyle.Secondary" Click="@ExportTrips" />
                </RadzenColumn>
                <RadzenColumn Size="12" SizeMD="6" Style="display: flex; gap: 0.5rem; align-items: center;">
                    <InputFile OnChange="@OnFileSelected" style="flex: 1" />
                    <RadzenButton Icon="upload" Text="Import" Click="OnImport" Disabled="@(importing || selectedFile is null)" />
                    @if (!string.IsNullOrEmpty(importMessage))
                    {
                        <span style="color: @(importError ? "#dc3545" : "#198754"); font-size: 0.9rem;">@importMessage</span>
                    }
                </RadzenColumn>
            </RadzenRow>

            <RadzenCard class="rz-mt-3">
                <RadzenDataGrid @ref="tripsGrid" Data="@trips" TItem="TripDto"
                                AllowFiltering="true" AllowSorting="true"
                                EditMode="DataGridEditMode.Single"
                                RowUpdate="@OnUpdateRow" RowCreate="@OnCreateRow">
                    <Columns>
                        <RadzenDataGridColumn TItem="TripDto" Property="ArrivalCity" Title="Arrival" Width="180px">
                            <Template Context="trip">
                                <div style="display: flex; flex-direction: column;">
                                    <span>@(!string.IsNullOrEmpty(trip.ArrivalIataCode) ? $"{trip.ArrivalIataCode} - " : "")@trip.ArrivalCity</span>
                                    <span style="font-size: 0.75rem; color: #666;">@GetTimezoneOffset(trip.ArrivalTimezone)</span>
                                </div>
                            </Template>
                            <EditTemplate Context="trip">
                                <RadzenText TextStyle="TextStyle.Body2">@trip.ArrivalCity</RadzenText>
                            </EditTemplate>
                        </RadzenDataGridColumn>
                        <RadzenDataGridColumn TItem="TripDto" Property="ArrivalDateTime" Title="Arrival Time" Width="150px">
                            <Template Context="trip">
                                @trip.ArrivalDateTime.ToString("yyyy-MM-dd HH:mm")
                            </Template>
                            <EditTemplate Context="trip">
                                <RadzenText TextStyle="TextStyle.Body2">@trip.ArrivalDateTime.ToString("yyyy-MM-dd HH:mm")</RadzenText>
                            </EditTemplate>
                        </RadzenDataGridColumn>
                        <RadzenDataGridColumn TItem="TripDto" Property="DepartureCity" Title="Departure" Width="180px">
                            <Template Context="trip">
                                <div style="display: flex; flex-direction: column;">
                                    <span>@(!string.IsNullOrEmpty(trip.DepartureIataCode) ? $"{trip.DepartureIataCode} - " : "")@trip.DepartureCity</span>
                                    <span style="font-size: 0.75rem; color: #666;">@GetTimezoneOffset(trip.DepartureTimezone)</span>
                                </div>
                            </Template>
                            <EditTemplate Context="trip">
                                <RadzenText TextStyle="TextStyle.Body2">@trip.DepartureCity</RadzenText>
                            </EditTemplate>
                        </RadzenDataGridColumn>
                        <RadzenDataGridColumn TItem="TripDto" Property="DepartureDateTime" Title="Departure Time" Width="150px">
                            <Template Context="trip">
                                @trip.DepartureDateTime.ToString("yyyy-MM-dd HH:mm")
                            </Template>
                            <EditTemplate Context="trip">
                                <RadzenText TextStyle="TextStyle.Body2">@trip.DepartureDateTime.ToString("yyyy-MM-dd HH:mm")</RadzenText>
                            </EditTemplate>
                        </RadzenDataGridColumn>
                        <RadzenDataGridColumn TItem="TripDto" Property="DurationDays" Title="Duration" Width="100px" Filterable="false" Sortable="true" TextAlign="TextAlign.Center">
                            <Template Context="trip">
                                @trip.DurationDays days
                            </Template>
                        </RadzenDataGridColumn>
                        <RadzenDataGridColumn TItem="TripDto" Context="trip" Filterable="false" Sortable="false" TextAlign="TextAlign.Center" Width="150px">
                            <Template Context="trip">
                                <RadzenButton Icon="edit" ButtonStyle="ButtonStyle.Light" Click="@(args => EditRow(trip))" Size="ButtonSize.Small" />
                                <RadzenButton Icon="delete" ButtonStyle="ButtonStyle.Danger" Click="@(args => DeleteRow(trip))" Size="ButtonSize.Small" />
                            </Template>
                            <EditTemplate Context="trip">
                                <RadzenButton Icon="check" ButtonStyle="ButtonStyle.Success" Click="@(args => SaveRow(trip))" Size="ButtonSize.Small" />
                                <RadzenButton Icon="close" ButtonStyle="ButtonStyle.Light" Click="@(args => CancelEdit(trip))" Size="ButtonSize.Small" />
                            </EditTemplate>
                        </RadzenDataGridColumn>
                    </Columns>
                </RadzenDataGrid>
                <RadzenButton Icon="add_circle_outline" Text="Add Trip" Click="@InsertRow" ButtonStyle="ButtonStyle.Success" class="rz-mt-2" />
            </RadzenCard>
        </RadzenTabsItem>

        <RadzenTabsItem Text="Trip Editor" Visible="@editingTrip">
            <RadzenCard class="rz-mt-3">
                <RadzenText TextStyle="TextStyle.H6">@(currentEditTrip?.Id > 0 ? "Edit Trip" : "Add New Trip")</RadzenText>
                
                @if (currentEditTrip != null)
                {
                    <RadzenStack Gap="1rem" class="rz-mt-3">
                        <RadzenText TextStyle="TextStyle.Subtitle1">Departure Information</RadzenText>
                        <AirportSelector Label="Departure Airport" 
                                        @bind-City="currentEditTrip.DepartureCity"
                                        @bind-Country="currentEditTrip.DepartureCountry"
                                        @bind-SelectedTimezone="currentEditTrip.DepartureTimezone"
                                        @bind-IataCode="currentEditTrip.DepartureIataCode"
                                        ShowTimezoneOffset="true"
                                        ShowManualOverride="true" />
                        
                        <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem">
                            <RadzenDatePicker @bind-Value="departureDate" Placeholder="Departure Date" Style="flex: 1" />
                            <RadzenDatePicker @bind-Value="departureTime" TimeOnly="true" Placeholder="Departure Time" Style="flex: 1" />
                        </RadzenStack>

                        <RadzenText TextStyle="TextStyle.Subtitle1" class="rz-mt-2">Arrival Information</RadzenText>
                        <AirportSelector Label="Arrival Airport" 
                                        @bind-City="currentEditTrip.ArrivalCity"
                                        @bind-Country="currentEditTrip.ArrivalCountry"
                                        @bind-SelectedTimezone="currentEditTrip.ArrivalTimezone"
                                        @bind-IataCode="currentEditTrip.ArrivalIataCode"
                                        ShowTimezoneOffset="true"
                                        ShowManualOverride="true" />
                        
                        <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem">
                            <RadzenDatePicker @bind-Value="arrivalDate" Placeholder="Arrival Date" Style="flex: 1" />
                            <RadzenDatePicker @bind-Value="arrivalTime" TimeOnly="true" Placeholder="Arrival Time" Style="flex: 1" />
                        </RadzenStack>

                        <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem" class="rz-mt-3">
                            <RadzenButton Icon="check" Text="Save Trip" Click="@SaveDetailedTrip" ButtonStyle="ButtonStyle.Success" />
                            <RadzenButton Icon="close" Text="Cancel" Click="@CancelDetailedEdit" ButtonStyle="ButtonStyle.Light" />
                        </RadzenStack>
                    </RadzenStack>
                }
            </RadzenCard>
        </RadzenTabsItem>
    </Tabs>
</RadzenTabs>

@code {
    private List<TripDto> trips = new();
    private RadzenDataGrid<TripDto>? tripsGrid;
    private IBrowserFile? selectedFile;
    private bool importing;
    private string importMessage = string.Empty;
    private bool importError;
    private bool editingTrip = false;
    private TripDto? currentEditTrip;
    private DateTime? departureDate;
    private DateTime? departureTime;
    private DateTime? arrivalDate;
    private DateTime? arrivalTime;

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        trips = await ApiClient.GetAllTripsAsync();
    }

    private async Task OnFileSelected(InputFileChangeEventArgs args)
    {
        selectedFile = args.File;
        importMessage = string.Empty;
        importError = false;
        await Task.CompletedTask;
    }

    private async Task OnImport()
    {
        if (selectedFile == null)
        {
            return;
        }

        importing = true;
        importMessage = string.Empty;
        importError = false;

        try
        {
            using var content = new MultipartFormDataContent();
            var stream = selectedFile.OpenReadStream(long.MaxValue);
            var streamContent = new StreamContent(stream);
            streamContent.Headers.ContentType = new MediaTypeHeaderValue(selectedFile.ContentType ?? "text/csv");
            content.Add(streamContent, "file", selectedFile.Name);

            var response = await Http.PostAsync("/api/trips/import", content);

            if (response.IsSuccessStatusCode)
            {
                importMessage = "Import completed";
                await LoadData();
            }
            else
            {
                var body = await response.Content.ReadAsStringAsync();
                importMessage = string.IsNullOrWhiteSpace(body) ? "Import failed" : body;
                importError = true;
            }
        }
        catch (Exception ex)
        {
            importMessage = $"Error: {ex.Message}";
            importError = true;
        }
        finally
        {
            importing = false;
        }
    }
    
    private async Task OnUpdateRow(TripDto trip)
    {
        await ApiClient.UpdateTripAsync(trip.Id, trip);
        await LoadData();
    }

    private async Task OnCreateRow(TripDto trip)
    {
        await ApiClient.CreateTripAsync(trip);
        await LoadData();
    }

    private void ExportTrips()
    {
        Navigation.NavigateTo("/api/trips/export", forceLoad: true);
    }

    private void EditRow(TripDto trip)
    {
        currentEditTrip = trip;
        editingTrip = true;
        
        // Initialize date/time fields
        departureDate = trip.DepartureDateTime.Date;
        departureTime = trip.DepartureDateTime;
        arrivalDate = trip.ArrivalDateTime.Date;
        arrivalTime = trip.ArrivalDateTime;
    }

    private async Task SaveRow(TripDto trip)
    {
        await tripsGrid!.UpdateRow(trip);
    }

    private void CancelEdit(TripDto trip)
    {
        tripsGrid!.CancelEditRow(trip);
        editingTrip = false;
    }

    private async Task DeleteRow(TripDto trip)
    {
        await ApiClient.DeleteTripAsync(trip.Id);
        await LoadData();
    }

    private void InsertRow()
    {
        currentEditTrip = new TripDto 
        { 
            DepartureTimezone = "UTC",
            ArrivalTimezone = "UTC"
        };
        departureDate = DateTime.Today;
        departureTime = DateTime.Today.AddHours(12);
        arrivalDate = DateTime.Today;
        arrivalTime = DateTime.Today.AddHours(12);
        editingTrip = true;
    }

    private async Task SaveDetailedTrip()
    {
        if (currentEditTrip == null || departureDate == null || departureTime == null || 
            arrivalDate == null || arrivalTime == null)
        {
            return;
        }

        // Combine date and time
        currentEditTrip.DepartureDateTime = departureDate.Value.Date.Add(departureTime.Value.TimeOfDay);
        currentEditTrip.ArrivalDateTime = arrivalDate.Value.Date.Add(arrivalTime.Value.TimeOfDay);

        if (currentEditTrip.Id > 0)
        {
            await ApiClient.UpdateTripAsync(currentEditTrip.Id, currentEditTrip);
        }
        else
        {
            await ApiClient.CreateTripAsync(currentEditTrip);
        }

        editingTrip = false;
        currentEditTrip = null;
        await LoadData();
    }

    private void CancelDetailedEdit()
    {
        editingTrip = false;
        currentEditTrip = null;
    }

    private string GetTimezoneOffset(string timezoneId)
    {
        if (string.IsNullOrEmpty(timezoneId))
            return string.Empty;

        try
        {
            var tz = TimeZoneInfo.FindSystemTimeZoneById(timezoneId);
            var offset = tz.GetUtcOffset(DateTime.UtcNow);
            var sign = offset < TimeSpan.Zero ? "-" : "+";
            return $"UTC{sign}{Math.Abs(offset.Hours):D2}:{Math.Abs(offset.Minutes):D2}";
        }
        catch
        {
            return timezoneId;
        }
    }
}
