@page "/manage-trips"
@attribute [Microsoft.AspNetCore.Authorization.Authorize]
@using Radzen
@using Radzen.Blazor
@using System.Globalization
@using System.Net.Http.Headers
@using Microsoft.AspNetCore.Components.Forms
@using ResidencyRoll.Shared.Trips
@using ResidencyRoll.Web.Services
@using ResidencyRoll.Web.Helpers
@using ResidencyRoll.Web.Components
@inject TripsApiClient ApiClient
@inject NavigationManager Navigation
@inject Microsoft.JSInterop.IJSRuntime JS
@rendermode InteractiveServer

<PageTitle>Manage Trips</PageTitle>

<h1>Manage Trips</h1>

<RadzenTabs @bind-SelectedIndex="selectedTabIndex">
    <Tabs>
        <RadzenTabsItem Text="Trip List">
            <RadzenRow Gap="1rem" class="rz-mt-3">
                <RadzenColumn Size="12" SizeMD="6">
                    <RadzenButton Icon="download" Text="Export Trips (CSV)" ButtonStyle="ButtonStyle.Secondary" Click="@ExportTrips" />
                </RadzenColumn>
                <RadzenColumn Size="12" SizeMD="6" Style="display: flex; gap: 0.5rem; align-items: center;">
                    <InputFile OnChange="@OnFileSelected" style="flex: 1" />
                    <RadzenButton Icon="upload" Text="Import" Click="OnImport" Disabled="@(importing || selectedFile is null)" />
                    @if (!string.IsNullOrEmpty(importMessage))
                    {
                        <span style="color: @(importError ? "#dc3545" : "#198754"); font-size: 0.9rem;">@importMessage</span>
                    }
                </RadzenColumn>
            </RadzenRow>

            <RadzenCard class="rz-mt-3">
                <RadzenDataGrid @ref="tripsGrid" Data="@trips" TItem="TripDto"
                                AllowFiltering="true" AllowSorting="true"
                                EditMode="DataGridEditMode.Single"
                                RowUpdate="@OnUpdateRow" RowCreate="@OnCreateRow">
                    <Columns>
                        <RadzenDataGridColumn TItem="TripDto" Property="DepartureCity" Title="Departure" Width="180px">
                            <Template Context="trip">
                                <div style="display: flex; flex-direction: column;">
                                    <span>@(!string.IsNullOrEmpty(trip.DepartureIataCode) ? $"{trip.DepartureIataCode} - " : "")@trip.DepartureCity</span>
                                    <span style="font-size: 0.75rem; color: #666;">@GetTimezoneOffset(trip.DepartureTimezone)</span>
                                </div>
                            </Template>
                            <EditTemplate Context="trip">
                                <RadzenText TextStyle="TextStyle.Body2">@trip.DepartureCity</RadzenText>
                            </EditTemplate>
                        </RadzenDataGridColumn>
                        <RadzenDataGridColumn TItem="TripDto" Property="DepartureDateTime" Title="Departure Time" Width="150px">
                            <Template Context="trip">
                                @trip.DepartureDateTime.ToString("yyyy-MM-dd HH:mm")
                            </Template>
                            <EditTemplate Context="trip">
                                <RadzenDatePicker @bind-Value="trip.DepartureDateTime" DateFormat="yyyy-MM-dd HH:mm" ShowTime="true" />
                            </EditTemplate>
                        </RadzenDataGridColumn>
                        <RadzenDataGridColumn TItem="TripDto" Property="ArrivalCity" Title="Arrival" Width="180px">
                            <Template Context="trip">
                                <div style="display: flex; flex-direction: column;">
                                    <span>@(!string.IsNullOrEmpty(trip.ArrivalIataCode) ? $"{trip.ArrivalIataCode} - " : "")@trip.ArrivalCity</span>
                                    <span style="font-size: 0.75rem; color: #666;">@GetTimezoneOffset(trip.ArrivalTimezone)</span>
                                </div>
                            </Template>
                            <EditTemplate Context="trip">
                                <RadzenText TextStyle="TextStyle.Body2">@trip.ArrivalCity</RadzenText>
                            </EditTemplate>
                        </RadzenDataGridColumn>
                        <RadzenDataGridColumn TItem="TripDto" Property="ArrivalDateTime" Title="Arrival Time" Width="150px">
                            <Template Context="trip">
                                @trip.ArrivalDateTime.ToString("yyyy-MM-dd HH:mm")
                            </Template>
                            <EditTemplate Context="trip">
                                <RadzenDatePicker @bind-Value="trip.ArrivalDateTime" DateFormat="yyyy-MM-dd HH:mm" ShowTime="true" />
                            </EditTemplate>
                        </RadzenDataGridColumn>
                        <RadzenDataGridColumn TItem="TripDto" Property="DurationHours" Title="Duration" Width="100px" Filterable="false" Sortable="true" TextAlign="TextAlign.Center">
                            <Template Context="trip">
                                @trip.DurationHours hours
                            </Template>
                            <EditTemplate Context="trip">
                                <RadzenText TextStyle="TextStyle.Body2" TextAlign="TextAlign.Center">@trip.DurationHours hours</RadzenText>
                            </EditTemplate>
                        </RadzenDataGridColumn>
                        <RadzenDataGridColumn TItem="TripDto" Context="trip" Filterable="false" Sortable="false" TextAlign="TextAlign.Center" Width="150px">
                            <Template Context="trip">
                                <RadzenButton Icon="edit" ButtonStyle="ButtonStyle.Light" Click="@(args => EditRow(trip))" Size="ButtonSize.Small" />
                                <RadzenButton Icon="flight_takeoff" Text="Add Leg" ButtonStyle="ButtonStyle.Info" Click="@(args => AddLeg(trip))" Size="ButtonSize.Small" class="rz-ml-1" />
                                <RadzenButton Icon="delete" ButtonStyle="ButtonStyle.Danger" Click="@(args => DeleteRow(trip))" Size="ButtonSize.Small" />
                            </Template>
                            <EditTemplate Context="trip">
                                <RadzenButton Icon="check" ButtonStyle="ButtonStyle.Success" Click="@(args => SaveRow(trip))" Size="ButtonSize.Small" />
                                <RadzenButton Icon="close" ButtonStyle="ButtonStyle.Light" Click="@(args => CancelEdit(trip))" Size="ButtonSize.Small" />
                            </EditTemplate>
                        </RadzenDataGridColumn>
                    </Columns>
                </RadzenDataGrid>
                <RadzenButton Icon="add_circle_outline" Text="Add Trip" Click="@InsertRow" ButtonStyle="ButtonStyle.Success" class="rz-mt-2" />
            </RadzenCard>
        </RadzenTabsItem>

        <RadzenTabsItem Text="Trip Editor" Visible="@editingTrip">
            <RadzenCard class="rz-mt-3">
                <RadzenText TextStyle="TextStyle.H6">@(currentEditTrip?.Id > 0 ? "Edit Trip" : "Add New Trip")</RadzenText>
                
                @if (currentEditTrip != null)
                {
                    <RadzenStack Gap="1rem" class="rz-mt-3">
                        <RadzenText TextStyle="TextStyle.Subtitle1">Departure Information</RadzenText>
                        <AirportSelector Label="Departure Airport" 
                                        @bind-City="currentEditTrip.DepartureCity"
                                        @bind-Country="currentEditTrip.DepartureCountry"
                                        @bind-SelectedTimezone="currentEditTrip.DepartureTimezone"
                                        @bind-IataCode="currentEditTrip.DepartureIataCode"
                                        ShowTimezoneOffset="true"
                                        ShowManualOverride="true" />
                        
                        <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem">
                            <RadzenDatePicker @bind-Value="departureDate"
                                             Placeholder="Departure Date"
                                             DateFormat="yyyy-MM-dd"
                                             Change="OnDepartureDateChanged"
                                             Style="flex: 1" />
                            <RadzenDatePicker @bind-Value="departureTime"
                                             TimeOnly="true"
                                             DateFormat="HH:mm"
                                             Placeholder="Departure Time"
                                             Style="flex: 1" />
                        </RadzenStack>

                        <RadzenText TextStyle="TextStyle.Subtitle1" class="rz-mt-2">Arrival Information</RadzenText>
                        <AirportSelector Label="Arrival Airport" 
                                        @bind-City="currentEditTrip.ArrivalCity"
                                        @bind-Country="currentEditTrip.ArrivalCountry"
                                        @bind-SelectedTimezone="currentEditTrip.ArrivalTimezone"
                                        @bind-IataCode="currentEditTrip.ArrivalIataCode"
                                        ShowTimezoneOffset="true"
                                        ShowManualOverride="true" />
                        
                        <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem">
                            <RadzenDatePicker @bind-Value="arrivalDate"
                                             Placeholder="Arrival Date"
                                             DateFormat="yyyy-MM-dd"
                                             Style="flex: 1" />
                            <RadzenDatePicker @bind-Value="arrivalTime"
                                             TimeOnly="true"
                                             DateFormat="HH:mm"
                                             Placeholder="Arrival Time"
                                             Style="flex: 1" />
                        </RadzenStack>

                        <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem" class="rz-mt-3">
                            <RadzenButton Icon="check" Text="Save Trip" Click="@SaveDetailedTrip" ButtonStyle="ButtonStyle.Success" />
                            <RadzenButton Icon="close" Text="Cancel" Click="@CancelDetailedEdit" ButtonStyle="ButtonStyle.Light" />
                        </RadzenStack>
                    </RadzenStack>
                }
            </RadzenCard>
        </RadzenTabsItem>
    </Tabs>
</RadzenTabs>

@code {
    private List<TripDto> trips = new();
    private RadzenDataGrid<TripDto>? tripsGrid;
    private IBrowserFile? selectedFile;
    private bool importing;
    private string importMessage = string.Empty;
    private bool importError;
    private bool editingTrip = false;
    private TripDto? currentEditTrip;
    private DateTime? departureDate;
    private DateTime? departureTime;
    private DateTime? arrivalDate;
    private DateTime? arrivalTime;
    private int selectedTabIndex = 0; // 0 = Trip List, 1 = Trip Editor

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        trips = (await ApiClient.GetAllTripsAsync()).OrderByDescending(t => t.DepartureDateTime).ToList();
    }

    private async Task OnFileSelected(InputFileChangeEventArgs args)
    {
        selectedFile = args.File;
        importMessage = string.Empty;
        importError = false;
        await Task.CompletedTask;
    }

    private async Task OnImport()
    {
        if (selectedFile == null)
        {
            return;
        }

        importing = true;
        importMessage = string.Empty;
        importError = false;

        try
        {
            using var stream = selectedFile.OpenReadStream(long.MaxValue);
            var (imported, message, errors) = await ApiClient.ImportTripsAsync(stream, selectedFile.Name);
            importMessage = message;
            importError = errors > 0 && imported == 0;
            await LoadData();
        }
        catch (Exception ex)
        {
            importMessage = $"Error: {ex.Message}";
            importError = true;
        }
        finally
        {
            importing = false;
        }
    }
    
    private async Task OnUpdateRow(TripDto trip)
    {
        await ApiClient.UpdateTripAsync(trip.Id, trip);
        await LoadData();
    }

    private async Task OnCreateRow(TripDto trip)
    {
        await ApiClient.CreateTripAsync(trip);
        await LoadData();
    }

    private async Task ExportTrips()
    {
        try
        {
            var csvBytes = await ApiClient.ExportTripsAsync();
            var base64 = Convert.ToBase64String(csvBytes);
            await JS.InvokeVoidAsync("downloadFile", "trips.csv", "text/csv", base64);
        }
        catch (Exception ex)
        {
            // Could show error message to user
            Console.WriteLine($"Export failed: {ex.Message}");
        }
    }

    private void EditRow(TripDto trip)
    {
        currentEditTrip = trip;
        editingTrip = true;
        selectedTabIndex = 1;
        
        // Initialize date/time fields
        departureDate = trip.DepartureDateTime.Date;
        departureTime = trip.DepartureDateTime;
        arrivalDate = trip.ArrivalDateTime.Date;
        arrivalTime = trip.ArrivalDateTime;
    }

    private async Task SaveRow(TripDto trip)
    {
        await tripsGrid!.UpdateRow(trip);
    }

    private void CancelEdit(TripDto trip)
    {
        tripsGrid!.CancelEditRow(trip);
        editingTrip = false;
    }

    private async Task DeleteRow(TripDto trip)
    {
        await ApiClient.DeleteTripAsync(trip.Id);
        await LoadData();
    }

    private void InsertRow()
    {
        currentEditTrip = new TripDto 
        { 
            DepartureTimezone = "UTC",
            ArrivalTimezone = "UTC"
        };
        departureDate = DateTime.Today;
        departureTime = DateTime.Today.AddHours(12);
        arrivalDate = DateTime.Today;
        arrivalTime = DateTime.Today.AddHours(12);
        editingTrip = true;
        selectedTabIndex = 1;
    }

    private void OnDepartureDateChanged(DateTime? newDate)
    {
        departureDate = newDate;

        var isExistingTrip = currentEditTrip?.Id > 0;
        arrivalDate = TripDateHelper.GetSyncedArrivalDate(newDate, arrivalDate, isExistingTrip);
    }

    private void AddLeg(TripDto baseTrip)
    {
        var newDepartureTime = baseTrip.ArrivalDateTime.AddHours(2);
        var fallbackTz = string.IsNullOrWhiteSpace(baseTrip.ArrivalTimezone) ? "UTC" : baseTrip.ArrivalTimezone;

        currentEditTrip = new TripDto
        {
            DepartureCountry = baseTrip.ArrivalCountry,
            DepartureCity = baseTrip.ArrivalCity,
            DepartureTimezone = fallbackTz,
            DepartureIataCode = baseTrip.ArrivalIataCode,
            ArrivalTimezone = fallbackTz,
            DepartureDateTime = newDepartureTime,
            ArrivalDateTime = newDepartureTime.AddHours(2)
        };

        departureDate = newDepartureTime.Date;
        departureTime = newDepartureTime;
        arrivalDate = newDepartureTime.AddHours(2).Date;
        arrivalTime = newDepartureTime.AddHours(2);

        editingTrip = true;
        selectedTabIndex = 1;
    }

    private async Task SaveDetailedTrip()
    {
        if (currentEditTrip == null || departureDate == null || departureTime == null || 
            arrivalDate == null || arrivalTime == null)
        {
            return;
        }

        // Combine date and time
        currentEditTrip.DepartureDateTime = departureDate.Value.Date.Add(departureTime.Value.TimeOfDay);
        currentEditTrip.ArrivalDateTime = arrivalDate.Value.Date.Add(arrivalTime.Value.TimeOfDay);

        if (currentEditTrip.Id > 0)
        {
            await ApiClient.UpdateTripAsync(currentEditTrip.Id, currentEditTrip);
        }
        else
        {
            await ApiClient.CreateTripAsync(currentEditTrip);
        }

        editingTrip = false;
        currentEditTrip = null;
        await LoadData();
        selectedTabIndex = 0; // Switch back to Trip List tab
        StateHasChanged();
    }

    private void CancelDetailedEdit()
    {
        editingTrip = false;
        currentEditTrip = null;
        selectedTabIndex = 0;
    }

    private string GetTimezoneOffset(string timezoneId)
    {
        if (string.IsNullOrEmpty(timezoneId))
            return string.Empty;

        try
        {
            var tz = TimeZoneInfo.FindSystemTimeZoneById(timezoneId);
            var offset = tz.GetUtcOffset(DateTime.UtcNow);
            var sign = offset < TimeSpan.Zero ? "-" : "+";
            return $"UTC{sign}{Math.Abs(offset.Hours):D2}:{Math.Abs(offset.Minutes):D2}";
        }
        catch
        {
            return timezoneId;
        }
    }
}
