@page "/manage-trips"
@attribute [Microsoft.AspNetCore.Authorization.Authorize]
@using Radzen
@using Radzen.Blazor
@using System.Globalization
@using System.Net.Http.Headers
@using Microsoft.AspNetCore.Components.Forms
@using ResidencyRoll.Shared.Trips
@using ResidencyRoll.Web.Services
@using ResidencyRoll.Web.Helpers
@using ResidencyRoll.Web.Components
@rendermode InteractiveServer

<PageTitle>Manage Trips</PageTitle>

<h1>Manage Trips</h1>

<RadzenTabs @bind-SelectedIndex="selectedTabIndex">
    <Tabs>
        <RadzenTabsItem Text="Trip List">
            <RadzenRow Gap="1rem" class="rz-mt-3">
                <RadzenColumn Size="12" SizeMD="6">
                    <RadzenButton Icon="download" Text="Export Trips (CSV)" ButtonStyle="ButtonStyle.Secondary" Click="@ExportTrips" />
                </RadzenColumn>
                <RadzenColumn Size="12" SizeMD="6" Style="display: flex; gap: 0.5rem; align-items: center;">
                    <InputFile OnChange="@OnFileSelected" style="flex: 1" />
                    <RadzenButton Icon="upload" Text="Import" Click="OnImport" Disabled="@(importing || selectedFile is null)" />
                    @if (!string.IsNullOrEmpty(importMessage))
                    {
                        <span style="color: @(importError ? "#dc3545" : "#198754"); font-size: 0.9rem;">@importMessage</span>
                    }
                </RadzenColumn>
            </RadzenRow>

            <RadzenCard class="rz-mt-3">
                <RadzenDataGrid @ref="tripsGrid" Data="@trips" TItem="TripDto"
                                AllowFiltering="true" AllowSorting="true"
                                EditMode="DataGridEditMode.Single"
                                RowUpdate="@OnUpdateRow" RowCreate="@OnCreateRow">
                    <Columns>
                        <RadzenDataGridColumn TItem="TripDto" Property="DepartureCity" Title="Departure" Width="180px">
                            <Template Context="trip">
                                <div style="display: flex; flex-direction: column;">
                                    <span>@(!string.IsNullOrEmpty(trip.DepartureIataCode) ? $"{trip.DepartureIataCode} - " : "")@trip.DepartureCity</span>
                                    <span style="font-size: 0.75rem; color: #666;">@GetTimezoneOffset(trip.DepartureTimezone)</span>
                                </div>
                            </Template>
                            <EditTemplate Context="trip">
                                <RadzenText TextStyle="TextStyle.Body2">@trip.DepartureCity</RadzenText>
                            </EditTemplate>
                        </RadzenDataGridColumn>
                        <RadzenDataGridColumn TItem="TripDto" Property="DepartureDateTime" Title="Departure Time" Width="150px">
                            <Template Context="trip">
                                @trip.DepartureDateTime.ToString("yyyy-MM-dd HH:mm")
                            </Template>
                            <EditTemplate Context="trip">
                                <RadzenDatePicker @bind-Value="trip.DepartureDateTime" DateFormat="yyyy-MM-dd HH:mm" ShowTime="true" />
                            </EditTemplate>
                        </RadzenDataGridColumn>
                        <RadzenDataGridColumn TItem="TripDto" Property="ArrivalCity" Title="Arrival" Width="180px">
                            <Template Context="trip">
                                <div style="display: flex; flex-direction: column;">
                                    <span>@(!string.IsNullOrEmpty(trip.ArrivalIataCode) ? $"{trip.ArrivalIataCode} - " : "")@trip.ArrivalCity</span>
                                    <span style="font-size: 0.75rem; color: #666;">@GetTimezoneOffset(trip.ArrivalTimezone)</span>
                                </div>
                            </Template>
                            <EditTemplate Context="trip">
                                <RadzenText TextStyle="TextStyle.Body2">@trip.ArrivalCity</RadzenText>
                            </EditTemplate>
                        </RadzenDataGridColumn>
                        <RadzenDataGridColumn TItem="TripDto" Property="ArrivalDateTime" Title="Arrival Time" Width="150px">
                            <Template Context="trip">
                                @trip.ArrivalDateTime.ToString("yyyy-MM-dd HH:mm")
                            </Template>
                            <EditTemplate Context="trip">
                                <RadzenDatePicker @bind-Value="trip.ArrivalDateTime" DateFormat="yyyy-MM-dd HH:mm" ShowTime="true" />
                            </EditTemplate>
                        </RadzenDataGridColumn>
                        <RadzenDataGridColumn TItem="TripDto" Property="DurationHours" Title="Duration" Width="100px" Filterable="false" Sortable="true" TextAlign="TextAlign.Center">
                            <Template Context="trip">
                                @trip.DurationHours hours
                            </Template>
                            <EditTemplate Context="trip">
                                <RadzenText TextStyle="TextStyle.Body2" TextAlign="TextAlign.Center">@trip.DurationHours hours</RadzenText>
                            </EditTemplate>
                        </RadzenDataGridColumn>
                        <RadzenDataGridColumn TItem="TripDto" Context="trip" Filterable="false" Sortable="false" TextAlign="TextAlign.Center" Width="150px">
                            <Template Context="trip">
                                <RadzenButton Icon="edit" ButtonStyle="ButtonStyle.Light" Click="@(args => EditRow(trip))" Size="ButtonSize.Small" />
                                <RadzenButton Icon="flight_takeoff" Text="Add Leg" ButtonStyle="ButtonStyle.Info" Click="@(args => AddLeg(trip))" Size="ButtonSize.Small" class="rz-ml-1" />
                                <RadzenButton Icon="delete" ButtonStyle="ButtonStyle.Danger" Click="@(args => DeleteRow(trip))" Size="ButtonSize.Small" />
                            </Template>
                            <EditTemplate Context="trip">
                                <RadzenButton Icon="check" ButtonStyle="ButtonStyle.Success" Click="@(args => SaveRow(trip))" Size="ButtonSize.Small" />
                                <RadzenButton Icon="close" ButtonStyle="ButtonStyle.Light" Click="@(args => CancelEdit(trip))" Size="ButtonSize.Small" />
                            </EditTemplate>
                        </RadzenDataGridColumn>
                    </Columns>
                </RadzenDataGrid>
                <RadzenButton Icon="add_circle_outline" Text="Add Trip" Click="@InsertRow" ButtonStyle="ButtonStyle.Success" class="rz-mt-2" />
            </RadzenCard>
        </RadzenTabsItem>

        <RadzenTabsItem Text="Trip Editor" Visible="@editingTrip">
            <RadzenCard class="rz-mt-3">
                <RadzenText TextStyle="TextStyle.H6">@(currentEditTrip?.Id > 0 ? "Edit Trip" : "Add New Trip")</RadzenText>
                
                @if (currentEditTrip != null)
                {
                    <RadzenStack Gap="1rem" class="rz-mt-3">
                        <RadzenText TextStyle="TextStyle.Subtitle1">Departure Information</RadzenText>
                        <AirportSelector Label="Departure Airport" 
                                        @bind-City="currentEditTrip.DepartureCity"
                                        @bind-Country="currentEditTrip.DepartureCountry"
                                        @bind-SelectedTimezone="currentEditTrip.DepartureTimezone"
                                        @bind-IataCode="currentEditTrip.DepartureIataCode"
                                        ShowTimezoneOffset="true"
                                        ShowManualOverride="true" />
                        
                        <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem">
                            <RadzenDatePicker @bind-Value="departureDate"
                                             Placeholder="Departure Date"
                                             DateFormat="yyyy-MM-dd"
                                             Change="OnDepartureDateChanged"
                                             Style="flex: 1" />
                            <RadzenDatePicker @bind-Value="departureTime"
                                             TimeOnly="true"
                                             DateFormat="HH:mm"
                                             Placeholder="Departure Time"
                                             Style="flex: 1" />
                        </RadzenStack>

                        <RadzenText TextStyle="TextStyle.Subtitle1" class="rz-mt-2">Arrival Information</RadzenText>
                        <AirportSelector Label="Arrival Airport" 
                                        @bind-City="currentEditTrip.ArrivalCity"
                                        @bind-Country="currentEditTrip.ArrivalCountry"
                                        @bind-SelectedTimezone="currentEditTrip.ArrivalTimezone"
                                        @bind-IataCode="currentEditTrip.ArrivalIataCode"
                                        ShowTimezoneOffset="true"
                                        ShowManualOverride="true" />
                        
                        <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem">
                            <RadzenDatePicker @bind-Value="arrivalDate"
                                             Placeholder="Arrival Date"
                                             DateFormat="yyyy-MM-dd"
                                             Style="flex: 1" />
                            <RadzenDatePicker @bind-Value="arrivalTime"
                                             TimeOnly="true"
                                             DateFormat="HH:mm"
                                             Placeholder="Arrival Time"
                                             Style="flex: 1" />
                        </RadzenStack>

                        <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem" class="rz-mt-3">
                            <RadzenButton Icon="check" Text="Save Trip" Click="@(() => SaveDetailedTrip())" ButtonStyle="ButtonStyle.Success" />
                            <RadzenButton Icon="playlist_add" Text="Save and Add Leg" Click="@(() => SaveDetailedTrip(addLegAfterSave: true))" ButtonStyle="ButtonStyle.Info" />
                            <RadzenButton Icon="close" Text="Cancel" Click="@CancelDetailedEdit" ButtonStyle="ButtonStyle.Light" />
                        </RadzenStack>
                        
                        @if (!string.IsNullOrEmpty(validationMessage))
                        {
                            <RadzenText TextStyle="TextStyle.Body2" Style="color: #dc3545; margin-top: 0.5rem;">
                                @validationMessage
                            </RadzenText>
                        }
                    </RadzenStack>
                }
            </RadzenCard>
        </RadzenTabsItem>
    </Tabs>
</RadzenTabs>
