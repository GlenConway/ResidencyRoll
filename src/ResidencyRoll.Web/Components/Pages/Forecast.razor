@page "/forecast"
@attribute [Microsoft.AspNetCore.Authorization.Authorize]
@using Radzen
@using Radzen.Blazor
@using System.Globalization
@using ResidencyRoll.Shared.Trips
@using ResidencyRoll.Web.Services
@using ResidencyRoll.Web.Components
@rendermode InteractiveServer

<PageTitle>Forecast - Residency Roll</PageTitle>

<h1>Trip Forecast</h1>

<RadzenCard class="rz-mt-4">
    <div style="display: flex; gap: 2rem; flex-direction: column;">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
                <RadzenText TextStyle="TextStyle.H6">Plan a Future Trip (Multi-leg Supported)</RadzenText>
                <RadzenText TextStyle="TextStyle.Caption" style="color: #666;">Total legs: @legs.Count</RadzenText>
            </div>
            <RadzenButton Icon="add_circle" Text="Add Leg" Click="@AddLeg" ButtonStyle="ButtonStyle.Success" Size="ButtonSize.Small" />
        </div>
        
        @foreach (var leg in legs)
        {
            var legIndex = legs.IndexOf(leg);
            <RadzenCard class="rz-mt-2" Style="background-color: #f8f9fa;" @key="leg.Id">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <RadzenText TextStyle="TextStyle.Subtitle1" Style="font-weight: bold;">
                        Leg @(legIndex + 1) @(legIndex == 0 ? "(Outbound)" : legIndex == legs.Count - 1 ? "(Return)" : "(Connecting)")
                    </RadzenText>
                    @if (legs.Count > 1)
                    {
                        <RadzenButton Icon="delete" ButtonStyle="ButtonStyle.Danger" Size="ButtonSize.Small" Click="@(() => RemoveLeg(leg.Id))" />
                    }
                </div>
                
                <div style="display: flex; flex-direction: column; gap: 1.5rem;">
                    <div>
                        <RadzenText TextStyle="TextStyle.Subtitle2">Departure</RadzenText>
                        <AirportSelector Label="Departure Airport" 
                                        @bind-City="leg.DepartureCity"
                                        @bind-Country="leg.DepartureCountry"
                                        @bind-SelectedTimezone="leg.DepartureTimezone"
                                        @bind-IataCode="leg.DepartureIataCode"
                                        ShowTimezoneOffset="true"
                                        ShowManualOverride="true" />
                        
                        <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem" class="rz-mt-2">
                            <RadzenDatePicker @bind-Value="leg.DepartureDate"
                                             Placeholder="Departure Date"
                                             DateFormat="yyyy-MM-dd"
                                             Change="@(args => OnDepartureDateChanged(leg, args))"
                                             Style="flex: 1" />
                            <RadzenDatePicker @bind-Value="leg.DepartureTime"
                                             TimeOnly="true"
                                             DateFormat="HH:mm"
                                             Placeholder="Departure Time"
                                             Style="flex: 1" />
                        </RadzenStack>
                    </div>

                    <div>
                        <RadzenText TextStyle="TextStyle.Subtitle2">Arrival</RadzenText>
                        <AirportSelector Label="Arrival Airport" 
                                        @bind-City="leg.ArrivalCity"
                                        @bind-Country="leg.ArrivalCountry"
                                        @bind-SelectedTimezone="leg.ArrivalTimezone"
                                        @bind-IataCode="leg.ArrivalIataCode"
                                        ShowTimezoneOffset="true"
                                        ShowManualOverride="true" />
                        
                        <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem" class="rz-mt-2">
                            <RadzenDatePicker @bind-Value="leg.ArrivalDate"
                                             Placeholder="Arrival Date"
                                             DateFormat="yyyy-MM-dd"
                                             Style="flex: 1" />
                            <RadzenDatePicker @bind-Value="leg.ArrivalTime"
                                             TimeOnly="true"
                                             DateFormat="HH:mm"
                                             Placeholder="Arrival Time"
                                             Style="flex: 1" />
                        </RadzenStack>
                    </div>
                </div>
            </RadzenCard>
        }
        
        <RadzenButton Click="CalculateForecast" Text="Calculate Forecast" ButtonStyle="ButtonStyle.Primary" class="rz-mt-2" />

        @if (forecastCalculated && legs.Count > 0)
        {
            var primaryCountry = GetPrimaryDestinationCountry();
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
                <div>
                    <h3>Current (Last 365 Days)</h3>
                    <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                        @if (currentDaysPerCountry.Count == 0)
                        {
                            <RadzenAlert Severity="AlertSeverity.Info">No trips recorded in the last 365 days.</RadzenAlert>
                        }
                        else
                        {
                            @foreach (var kvp in currentDaysPerCountry.OrderByDescending(x => x.Value))
                            {
                                <div style="display: flex; justify-content: space-between; padding: 0.75rem; background: #f8f9fa; border-radius: 4px;">
                                    <span><strong>@kvp.Key</strong></span>
                                    <span>@kvp.Value days</span>
                                </div>
                            }
                            <div style="display: flex; justify-content: space-between; padding: 0.75rem; background: #e7f1ff; border-radius: 4px; font-weight: 600; margin-top: 0.5rem;">
                                <span>Total Away</span>
                                <span>@currentDaysPerCountry.Values.Sum() days</span>
                            </div>
                        }
                    </div>
                </div>

                <div>
                    <h3>Forecast (365 Days from Trip End)</h3>
                    <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                        @if (forecastDaysPerCountry.Count == 0)
                        {
                            <RadzenAlert Severity="AlertSeverity.Info">No trips in forecast period.</RadzenAlert>
                        }
                        else
                        {
                            var visitedCountries = legs.Select(l => l.ArrivalCountry).Where(c => !string.IsNullOrEmpty(c)).Distinct().ToList();
                            
                            @foreach (var kvp in forecastDaysPerCountry.OrderByDescending(x => x.Value))
                            {
                                var isVisitedCountry = visitedCountries.Contains(kvp.Key);
                                var daysInCountry = kvp.Value;
                                var exceedsLimit = daysInCountry > 183;
                                var style = isVisitedCountry ? (exceedsLimit ? "background: #f8d7da; border: 2px solid #dc3545;" : "background: #d4edda; border: 2px solid #28a745;") : "background: #f8f9fa;";
                                var tripDuration = GetTripDurationDays();
                                
                                <div style="display: flex; justify-content: space-between; padding: 0.75rem; @style border-radius: 4px;">
                                    <span>
                                        <strong>@kvp.Key</strong>
                                        @if (isVisitedCountry && tripDuration > 0)
                                        {
                                            <span style="font-size: 0.9rem; margin-left: 0.5rem;">
                                                (+ @tripDuration days)
                                                @if (exceedsLimit)
                                                {
                                                    <span style="color: #dc3545; font-weight: bold;"> ⚠️ Exceeds 183</span>
                                                }
                                            </span>
                                        }
                                    </span>
                                    <span>@daysInCountry days</span>
                                </div>
                            }
                            <div style="display: flex; justify-content: space-between; padding: 0.75rem; background: #e7f1ff; border-radius: 4px; font-weight: 600; margin-top: 0.5rem;">
                                <span>Total Away</span>
                                <span>@forecastDaysPerCountry.Values.Sum() days</span>
                            </div>
                        }
                    </div>
                </div>
            </div>

            @if (!string.IsNullOrEmpty(primaryCountry))
            {
                var forecastCountryDays = forecastDaysPerCountry.ContainsKey(primaryCountry) ? forecastDaysPerCountry[primaryCountry] : 0;
                
                @if (forecastCountryDays > 183)
                {
                    <div style="margin-top: 2rem; padding: 1rem; background: #fff3cd; border: 1px solid #ffc107; border-radius: 4px;">
                        <h3 style="margin-top: 0;">183-Day Limit Warning</h3>
                        <RadzenAlert Severity="AlertSeverity.Warning" class="rz-mt-2">
                            Your forecasted trip would result in <strong>@forecastCountryDays days</strong> in @primaryCountry over a 365-day period, 
                            which exceeds the typical 183-day limit for tax residency.
                        </RadzenAlert>
                        <p style="font-size: 0.9rem; color: #666; margin-top: 1rem;">
                            Consider adjusting your trip dates or duration to stay below the limit.
                        </p>
                    </div>
                }
            }
        }
    </div>
</RadzenCard>