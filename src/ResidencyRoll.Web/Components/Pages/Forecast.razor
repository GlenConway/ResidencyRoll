@page "/forecast"
@attribute [Microsoft.AspNetCore.Authorization.Authorize]
@using Radzen
@using Radzen.Blazor
@using System.Globalization
@using ResidencyRoll.Shared.Trips
@using ResidencyRoll.Web.Services
@using ResidencyRoll.Web.Components
@rendermode InteractiveServer

<PageTitle>Forecast - Residency Roll</PageTitle>

<h1>Trip Forecast</h1>

<RadzenCard class="rz-mt-4">
    <div style="display: flex; gap: 2rem; flex-direction: column;">
        <RadzenText TextStyle="TextStyle.H6">Plan a Future Trip</RadzenText>
        
        <div style="display: flex; flex-direction: column; gap: 1.5rem;">
            <RadzenText TextStyle="TextStyle.Subtitle1">Departure Information</RadzenText>
            <AirportSelector Label="Departure Airport" 
                            @bind-City="departureCity"
                            @bind-Country="departureCountry"
                            @bind-SelectedTimezone="departureTimezone"
                            @bind-IataCode="departureIataCode"
                            ShowTimezoneOffset="true"
                            ShowManualOverride="true" />
            
            <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem">
                <RadzenDatePicker @bind-Value="departureDate"
                                 Placeholder="Departure Date"
                                 DateFormat="yyyy-MM-dd"
                                 Style="flex: 1" />
                <RadzenDatePicker @bind-Value="departureTime"
                                 TimeOnly="true"
                                 DateFormat="HH:mm"
                                 Placeholder="Departure Time"
                                 Style="flex: 1" />
            </RadzenStack>

            <RadzenText TextStyle="TextStyle.Subtitle1" class="rz-mt-2">Arrival Information</RadzenText>
            <AirportSelector Label="Arrival Airport" 
                            @bind-City="arrivalCity"
                            @bind-Country="arrivalCountry"
                            @bind-SelectedTimezone="arrivalTimezone"
                            @bind-IataCode="arrivalIataCode"
                            ShowTimezoneOffset="true"
                            ShowManualOverride="true" />
            
            <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem">
                <RadzenDatePicker @bind-Value="arrivalDate"
                                 Placeholder="Arrival Date"
                                 DateFormat="yyyy-MM-dd"
                                 Style="flex: 1" />
                <RadzenDatePicker @bind-Value="arrivalTime"
                                 TimeOnly="true"
                                 DateFormat="HH:mm"
                                 Placeholder="Arrival Time"
                                 Style="flex: 1" />
            </RadzenStack>
            
            <RadzenButton Click="CalculateForecast" Text="Calculate Forecast" ButtonStyle="ButtonStyle.Primary" class="rz-mt-2" />
        </div>

        @if (forecastCalculated && !string.IsNullOrEmpty(arrivalCountry))
        {
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
                <div>
                    <h3>Current (Last 365 Days)</h3>
                    <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                        @if (currentDaysPerCountry.Count == 0)
                        {
                            <RadzenAlert Severity="AlertSeverity.Info">No trips recorded in the last 365 days.</RadzenAlert>
                        }
                        else
                        {
                            @foreach (var kvp in currentDaysPerCountry.OrderByDescending(x => x.Value))
                            {
                                <div style="display: flex; justify-content: space-between; padding: 0.75rem; background: #f8f9fa; border-radius: 4px;">
                                    <span><strong>@kvp.Key</strong></span>
                                    <span>@kvp.Value days</span>
                                </div>
                            }
                            <div style="display: flex; justify-content: space-between; padding: 0.75rem; background: #e7f1ff; border-radius: 4px; font-weight: 600; margin-top: 0.5rem;">
                                <span>Total Away</span>
                                <span>@currentDaysPerCountry.Values.Sum() days</span>
                            </div>
                        }
                    </div>
                </div>

                <div>
                    <h3>Forecast (365 Days from Trip End)</h3>
                    <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                        @if (forecastDaysPerCountry.Count == 0)
                        {
                            <RadzenAlert Severity="AlertSeverity.Info">No trips in forecast period.</RadzenAlert>
                        }
                        else
                        {
                            @foreach (var kvp in forecastDaysPerCountry.OrderByDescending(x => x.Value))
                            {
                                var isNewTrip = kvp.Key == arrivalCountry;
                                var daysInCountry = kvp.Value;
                                var exceedsLimit = daysInCountry > 183;
                                var style = isNewTrip ? (exceedsLimit ? "background: #f8d7da; border: 2px solid #dc3545;" : "background: #d4edda; border: 2px solid #28a745;") : "background: #f8f9fa;";
                                var tripDuration = GetTripDurationDays();
                                
                                <div style="display: flex; justify-content: space-between; padding: 0.75rem; @style border-radius: 4px;">
                                    <span>
                                        <strong>@kvp.Key</strong>
                                        @if (isNewTrip && tripDuration > 0)
                                        {
                                            <span style="font-size: 0.9rem; margin-left: 0.5rem;">
                                                (+ @tripDuration days)
                                                @if (exceedsLimit)
                                                {
                                                    <span style="color: #dc3545; font-weight: bold;"> ⚠️ Exceeds 183</span>
                                                }
                                            </span>
                                        }
                                    </span>
                                    <span>@daysInCountry days</span>
                                </div>
                            }
                            <div style="display: flex; justify-content: space-between; padding: 0.75rem; background: #e7f1ff; border-radius: 4px; font-weight: 600; margin-top: 0.5rem;">
                                <span>Total Away</span>
                                <span>@forecastDaysPerCountry.Values.Sum() days</span>
                            </div>
                        }
                    </div>
                </div>
            </div>

            @if (!string.IsNullOrEmpty(arrivalCountry))
            {
                var forecastCountryDays = forecastDaysPerCountry.ContainsKey(arrivalCountry) ? forecastDaysPerCountry[arrivalCountry] : 0;
                
                @if (forecastCountryDays > 183)
                {
                    <div style="margin-top: 2rem; padding: 1rem; background: #fff3cd; border: 1px solid #ffc107; border-radius: 4px;">
                        <h3 style="margin-top: 0;">183-Day Limit Planning</h3>
                        
                        @if (maxEndDateForLimit.HasValue)
                        {
                            <div style="margin-bottom: 1rem;">
                                <p><strong>Maximum safe end date:</strong> @maxEndDateForLimit.Value.ToString("MMM dd, yyyy")</p>
                                <p style="font-size: 0.9rem; color: #666;">This is the latest you can end your trip and stay at or below 183 days in @arrivalCountry during the 365-day window.</p>
                            </div>
                        }

                        <h4>Standard Duration Windows</h4>
                        <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                            @foreach (var window in standardDurationForecasts)
                            {
                                var exceeds = window.ExceedsLimit;
                                var windowStyle = exceeds ? "background: #ffebee; border-left: 4px solid #dc3545;" : "background: #e8f5e9; border-left: 4px solid #28a745;";
                                
                                <div style="padding: 0.75rem; @windowStyle border-radius: 2px;">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <span>
                                            <strong>@window.DurationDays days</strong> 
                                            (@GetArrivalDateTime().ToString("MMM dd") – @window.EndDate.ToString("MMM dd, yyyy"))
                                        </span>
                                        <span style="font-weight: 600; @(exceeds ? "color: #dc3545;" : "color: #28a745;")">
                                            @window.TotalDaysInCountry days
                                            @if (exceeds)
                                            {
                                                <span>❌ Over limit</span>
                                            }
                                            else
                                            {
                                                <span>✓ Safe</span>
                                            }
                                        </span>
                                    </div>
                                </div>
                            }
                        </div>
                    </div>
                }
            }
        }
    </div>
</RadzenCard>