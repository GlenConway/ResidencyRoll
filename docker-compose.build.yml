# Docker Compose file for building locally with version support
# Usage: APP_VERSION=1.2.3 docker-compose -f docker-compose.build.yml build
# Then: docker-compose -f docker-compose.build.yml up

services:
  residencyroll-api:
    build:
      context: .
      dockerfile: Dockerfile.api
      args:
        VERSION: ${APP_VERSION:-1.0.0}
    image: residencyroll-api:${APP_VERSION:-1.0.0}
    container_name: ResidencyRoll-Api
    ports:
      - "${API_PORT:-5000}:${API_INTERNAL_PORT:-80}"
    volumes:
      - residencyroll-api-data:/app/data
    environment:
      - ASPNETCORE_ENVIRONMENT=${ASPNETCORE_ENVIRONMENT:-Development}
      - ASPNETCORE_URLS=http://+:${API_INTERNAL_PORT:-80}
      - ConnectionStrings__Default=Data Source=${DB_PATH:-/app/data/residencyroll.db}
      - Jwt__Authority=${JWT_AUTHORITY:-https://your-identity-provider.com}
      - Jwt__Audience=${JWT_AUDIENCE:-https://your-api-audience}
      - Jwt__RequireHttpsMetadata=${JWT_REQUIRE_HTTPS:-false}
      - Jwt__ClientSecret=${OIDC_CLIENT_SECRET}
      - Cors__AllowedOrigins__0=${CORS_ORIGIN_0:-http://localhost:8080}
      - Cors__AllowedOrigins__1=${CORS_ORIGIN_1:-http://localhost:5001}
      - ForwardedHeaders__KnownProxies__0=${FORWARDED_HEADERS_KNOWN_PROXY_0}
      - ForwardedHeaders__KnownProxies__1=${FORWARDED_HEADERS_KNOWN_PROXY_1}
      - ForwardedHeaders__KnownNetworks__0=${FORWARDED_HEADERS_KNOWN_NETWORK_0}
      - ForwardedHeaders__KnownNetworks__1=${FORWARDED_HEADERS_KNOWN_NETWORK_1}
    restart: unless-stopped
    networks:
      - residencyroll-network

  residencyroll-web:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        VERSION: ${APP_VERSION:-1.0.0}
    image: residencyroll-web:${APP_VERSION:-1.0.0}
    container_name: ResidencyRoll-Web
    ports:
      - "${WEB_PORT:-8080}:${WEB_INTERNAL_PORT:-8080}"
    volumes:
      - residencyroll-web-data:/app/data
    environment:
      - ASPNETCORE_ENVIRONMENT=${ASPNETCORE_ENVIRONMENT:-Development}
      - ASPNETCORE_URLS=http://+:${WEB_INTERNAL_PORT:-8080}
      - Api__BaseUrl=http://residencyroll-api:${API_INTERNAL_PORT:-80}
      - Authentication__OpenIdConnect__Enabled=${OIDC_ENABLED:-false}
      - Authentication__OpenIdConnect__Authority=${OIDC_AUTHORITY:-https://your-identity-provider.com}
      - Authentication__OpenIdConnect__ClientId=${OIDC_CLIENT_ID}
      - Authentication__OpenIdConnect__ClientSecret=${OIDC_CLIENT_SECRET}
      - Authentication__OpenIdConnect__RequireHttpsMetadata=${OIDC_REQUIRE_HTTPS:-false}
      - Authentication__OpenIdConnect__ApiAudience=${OIDC_API_AUDIENCE:-https://your-api-audience}
      - ForwardedHeaders__KnownProxies__0=${FORWARDED_HEADERS_KNOWN_PROXY_0}
      - ForwardedHeaders__KnownProxies__1=${FORWARDED_HEADERS_KNOWN_PROXY_1}
      - ForwardedHeaders__KnownNetworks__0=${FORWARDED_HEADERS_KNOWN_NETWORK_0}
      - ForwardedHeaders__KnownNetworks__1=${FORWARDED_HEADERS_KNOWN_NETWORK_1}
    restart: unless-stopped
    depends_on:
      - residencyroll-api
    networks:
      - residencyroll-network

volumes:
  residencyroll-api-data:
  residencyroll-web-data:

networks:
  residencyroll-network:
    driver: bridge
